{"version":3,"file":"index.js","sources":["../src/KeepAliveWebSocket.ts"],"sourcesContent":["import {\n\tEventEmitter,\n\ttype EventEmitter as EventEmitterTypes,\n} from \"eventemitter3\";\n\nexport type KeepAliveWebSocketEvents = {\n\topen(): void;\n\tmessage(data: string | ArrayBufferLike | Blob | ArrayBufferView): void;\n\terror(error?: Error): void;\n\tdisconnect(): void;\n\tclose(): void;\n\ttest(a: number, b: number): void;\n};\n\ntype KeepAliveWebSocketEventNames =\n\tEventEmitterTypes.EventNames<KeepAliveWebSocketEvents>;\ntype KeepAliveWebSocketEventArguments =\n\tEventEmitterTypes.ArgumentMap<KeepAliveWebSocketEvents>;\ntype EventEmitterReturnType<T> = T extends []\n\t? // biome-ignore lint/suspicious/noConfusingVoidType: <explanation>\n\t\tvoid\n\t: T extends [infer R]\n\t\t? R\n\t\t: T;\n\nexport type KeepAliveWebSocketOptions = {\n\turl: () => Promise<string> | string;\n\tminTimeBetweenReconnectsMS?: number;\n\tautoconnect?: boolean;\n\tWebSocket?: typeof WebSocket;\n};\n\nexport class KeepAliveWebSocket extends EventEmitter<KeepAliveWebSocketEvents> {\n\tprivate url: () => Promise<string> | string;\n\tprivate connected = false;\n\tprivate connecting = false;\n\tprivate reconnecting = false;\n\tprivate closed = false;\n\tprivate websocket: WebSocket | undefined;\n\tprivate connectTime = Date.now();\n\tprivate minTimeBetweenReconnectsMS = 0;\n\tprivate WebSocket: typeof WebSocket;\n\n\tconstructor(options: KeepAliveWebSocketOptions) {\n\t\tsuper();\n\t\tthis.url = options.url;\n\t\tif (options.WebSocket) {\n\t\t\tthis.WebSocket = options.WebSocket;\n\t\t} else {\n\t\t\tthis.WebSocket = WebSocket;\n\t\t}\n\t\tif (options.minTimeBetweenReconnectsMS) {\n\t\t\tthis.minTimeBetweenReconnectsMS = options.minTimeBetweenReconnectsMS;\n\t\t}\n\t\tif (options.autoconnect) {\n\t\t\tthis.connect();\n\t\t}\n\t}\n\n\tsend(data: string | ArrayBufferLike | Blob | ArrayBufferView) {\n\t\tif (!this.connected) {\n\t\t\tthrow new Error(\"WebSocket not ready\");\n\t\t}\n\t\tthis.websocket?.send(data);\n\t\treturn this;\n\t}\n\n\tready() {\n\t\tif (this.connected) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\t\treturn this.waitOnce(\"open\");\n\t}\n\n\twaitOnce<K extends KeepAliveWebSocketEventNames>(event: K) {\n\t\treturn new Promise<\n\t\t\tEventEmitterReturnType<KeepAliveWebSocketEventArguments[K]>\n\t\t>((resolve) => {\n\t\t\tthis.once(event, (...args) => {\n\t\t\t\tswitch (args.length) {\n\t\t\t\t\tcase 0:\n\t\t\t\t\t\tresolve(undefined as never);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 1:\n\t\t\t\t\t\tresolve(args[0]);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tresolve(args as never);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tclose(code?: number, reason?: string) {\n\t\tthis.connected = false;\n\t\tthis.connecting = false;\n\t\tthis.closed = true;\n\t\tif (this.websocket) {\n\t\t\tthis.websocket.close(code, reason);\n\t\t} else {\n\t\t\tthis.emit(\"close\");\n\t\t}\n\t}\n\n\tasync connect() {\n\t\tif (this.connected) {\n\t\t\treturn this;\n\t\t}\n\t\tif (this.connecting) {\n\t\t\treturn this;\n\t\t}\n\t\tthis.connecting = true;\n\t\ttry {\n\t\t\tthis.connectTime = Date.now();\n\t\t\tconst websocket = new this.WebSocket(await this.url());\n\n\t\t\tconst onOpen = () => {\n\t\t\t\twebsocket.removeEventListener(\"open\", onOpen);\n\t\t\t\tthis.connected = true;\n\t\t\t\tthis.emit(\"open\");\n\t\t\t};\n\t\t\twebsocket.addEventListener(\"open\", onOpen);\n\n\t\t\twebsocket.addEventListener(\"close\", () => {\n\t\t\t\tthis.websocket = undefined;\n\t\t\t\tthis.connected = false;\n\t\t\t\tif (this.closed) {\n\t\t\t\t\tthis.emit(\"close\");\n\t\t\t\t} else {\n\t\t\t\t\tthis.emit(\"disconnect\");\n\t\t\t\t\tthis.reconnect();\n\t\t\t\t}\n\t\t\t});\n\t\t\twebsocket.addEventListener(\"message\", (event) => {\n\t\t\t\tthis.emit(\"message\", event.data);\n\t\t\t});\n\t\t\twebsocket.addEventListener(\"error\", () => {\n\t\t\t\tthis.emit(\"error\");\n\t\t\t});\n\n\t\t\tthis.websocket = websocket;\n\t\t} catch (error) {\n\t\t\tthis.emit(\"error\", error as Error);\n\t\t\tthis.reconnect();\n\t\t} finally {\n\t\t\tthis.connecting = false;\n\t\t}\n\t\treturn this;\n\t}\n\n\tprivate reconnect() {\n\t\tif (this.reconnecting) {\n\t\t\treturn this;\n\t\t}\n\t\tthis.reconnecting = true;\n\t\ttry {\n\t\t\tconst timeSinceLastConnect = Date.now() - this.connectTime;\n\t\t\tif (timeSinceLastConnect < this.minTimeBetweenReconnectsMS) {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tthis.connect();\n\t\t\t\t}, this.minTimeBetweenReconnectsMS - timeSinceLastConnect);\n\t\t\t} else {\n\t\t\t\tthis.connect();\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.reconnecting = false;\n\t\t}\n\t\treturn this;\n\t}\n}\n"],"names":["KeepAliveWebSocket","EventEmitter","constructor","options","super","this","connected","connecting","reconnecting","closed","connectTime","Date","now","minTimeBetweenReconnectsMS","url","WebSocket","autoconnect","connect","send","data","Error","_a","websocket","ready","Promise","resolve","waitOnce","event","once","args","length","undefined","close","code","reason","emit","onOpen","removeEventListener","addEventListener","reconnect","error","timeSinceLastConnect","setTimeout"],"mappings":"+FAgCM,MAAOA,UAA2BC,EAWvC,WAAAC,CAAYC,GACXC,QAVOC,KAASC,WAAG,EACZD,KAAUE,YAAG,EACbF,KAAYG,cAAG,EACfH,KAAMI,QAAG,EAETJ,KAAAK,YAAcC,KAAKC,MACnBP,KAA0BQ,2BAAG,EAKpCR,KAAKS,IAAMX,EAAQW,IACfX,EAAQY,UACXV,KAAKU,UAAYZ,EAAQY,UAEzBV,KAAKU,UAAYA,UAEdZ,EAAQU,6BACXR,KAAKQ,2BAA6BV,EAAQU,4BAEvCV,EAAQa,aACXX,KAAKY,SAEN,CAED,IAAAC,CAAKC,SACJ,IAAKd,KAAKC,UACT,MAAM,IAAIc,MAAM,uBAGjB,OADc,QAAdC,EAAAhB,KAAKiB,iBAAS,IAAAD,GAAAA,EAAEH,KAAKC,GACdd,IACP,CAED,KAAAkB,GACC,OAAIlB,KAAKC,UACDkB,QAAQC,UAETpB,KAAKqB,SAAS,OACrB,CAED,QAAAA,CAAiDC,GAChD,OAAO,IAAIH,SAERC,IACFpB,KAAKuB,KAAKD,GAAO,IAAIE,KACpB,OAAQA,EAAKC,QACZ,KAAK,EACJL,OAAQM,GACR,MACD,KAAK,EACJN,EAAQI,EAAK,IACb,MACD,QACCJ,EAAQI,GAET,GACA,GAEH,CAED,KAAAG,CAAMC,EAAeC,GACpB7B,KAAKC,WAAY,EACjBD,KAAKE,YAAa,EAClBF,KAAKI,QAAS,EACVJ,KAAKiB,UACRjB,KAAKiB,UAAUU,MAAMC,EAAMC,GAE3B7B,KAAK8B,KAAK,QAEX,CAED,aAAMlB,GACL,GAAIZ,KAAKC,UACR,OAAOD,KAER,GAAIA,KAAKE,WACR,OAAOF,KAERA,KAAKE,YAAa,EAClB,IACCF,KAAKK,YAAcC,KAAKC,MACxB,MAAMU,EAAY,IAAIjB,KAAKU,gBAAgBV,KAAKS,OAE1CsB,EAAS,KACdd,EAAUe,oBAAoB,OAAQD,GACtC/B,KAAKC,WAAY,EACjBD,KAAK8B,KAAK,OAAO,EAElBb,EAAUgB,iBAAiB,OAAQF,GAEnCd,EAAUgB,iBAAiB,SAAS,KACnCjC,KAAKiB,eAAYS,EACjB1B,KAAKC,WAAY,EACbD,KAAKI,OACRJ,KAAK8B,KAAK,UAEV9B,KAAK8B,KAAK,cACV9B,KAAKkC,YACL,IAEFjB,EAAUgB,iBAAiB,WAAYX,IACtCtB,KAAK8B,KAAK,UAAWR,EAAMR,KAAK,IAEjCG,EAAUgB,iBAAiB,SAAS,KACnCjC,KAAK8B,KAAK,QAAQ,IAGnB9B,KAAKiB,UAAYA,CACjB,CAAC,MAAOkB,GACRnC,KAAK8B,KAAK,QAASK,GACnBnC,KAAKkC,WACL,CAAS,QACTlC,KAAKE,YAAa,CAClB,CACD,OAAOF,IACP,CAEO,SAAAkC,GACP,GAAIlC,KAAKG,aACR,OAAOH,KAERA,KAAKG,cAAe,EACpB,IACC,MAAMiC,EAAuB9B,KAAKC,MAAQP,KAAKK,YAC3C+B,EAAuBpC,KAAKQ,2BAC/B6B,YAAW,KACVrC,KAAKY,SAAS,GACZZ,KAAKQ,2BAA6B4B,GAErCpC,KAAKY,SAEN,CAAS,QACTZ,KAAKG,cAAe,CACpB,CACD,OAAOH,IACP"}